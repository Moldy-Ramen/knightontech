"use strict";(()=>{var e={};e.id=491,e.ids=[491],e.modules={195:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{default:()=>c});var a=r(6037),i=r.n(a),o=r(2656),s=r(9767),d=e([s]);let p=new(s=(d.then?(await d)():d)[0]).default(process.env.STRIPE_SECRET_KEY,{apiVersion:"2022-11-15"}),l=process.env.MONGODB_URI;if(!l)throw Error("Define MONGODB_URI in .env.local");let y=global._mongo;async function u(){return y.conn||(y.promise||(y.promise=i().connect(l)),y.conn=await y.promise),y.conn}async function c(e,t){let r;if("POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).end("Method not allowed");let{items:n,name:a,email:i,phone:s,address:d,shipping:c,tax:l,deliveryOption:y}=e.body,m=0;n.forEach(e=>{let t=parseFloat(e.price.replace(/[^0-9.-]+/g,""))||0;m+=t*e.qty}),m=parseFloat(m.toFixed(2));let _=n.map(e=>({price_data:{currency:"usd",product_data:{name:e.name},unit_amount:Math.round(100*parseFloat(e.price.replace(/[^0-9.-]+/g,"")))},quantity:e.qty})),g=parseFloat(l)||0;g>0&&_.push({price_data:{currency:"usd",product_data:{name:"Sales Tax"},unit_amount:Math.round(100*g)},quantity:1});let h=c?.rate?parseFloat(c.rate):0;h>0&&_.push({price_data:{currency:"usd",product_data:{name:`Shipping (${c.carrier})`},unit_amount:Math.round(100*h)},quantity:1});try{r=await p.checkout.sessions.create({payment_method_types:["card"],line_items:_,mode:"payment",customer_creation:"always",customer_email:i,shipping_address_collection:{allowed_countries:["US"]},phone_number_collection:{enabled:!0},payment_intent_data:{metadata:{name:a||"",phone:s||"",address_line1:d?.line1||"",address_city:d?.city||"",address_state:d?.state||"",address_postal_code:d?.postal_code||"",address_country:d?.country||"",items:JSON.stringify(n),subtotal_amount:m.toString(),tax_amount:g.toString(),shipping_rate:h.toString(),shipping_carrier:c?.carrier||y||"",shipping_delivery_days:c?.delivery_days?.toString()||"",shipping_estimated_delivery:c?.estimated_delivery||"",delivery_option:y||""}},cancel_url:`${e.headers.origin}/cart`,success_url:`${e.headers.origin}/success?session_id={CHECKOUT_SESSION_ID}`,expand:["payment_intent"]})}catch(e){return console.error("❌ Stripe session creation failed:",e),t.status(500).json({error:"Stripe session creation failed"})}let S=`KT-${Date.now()}`;try{await u(),await o.A.create({orderNumber:S,name:a,email:i,phone:s,address:{line1:d.line1,city:d.city,state:d.state,postal_code:d.postal_code,country:d.country},items:n.map(e=>({name:e.name,qty:e.qty,price:e.price})),subtotal:m,tax:g,shipping:{carrier:c?.carrier||y||"Local Pickup",rate:h,delivery_days:c?.delivery_days||null,estimated_delivery:c?.estimated_delivery||null},total:parseFloat((m+g+h).toFixed(2)),deliveryOption:y,payment_intent:r.payment_intent.id})}catch(e){console.error("❌ Order saving failed:",e)}return t.status(200).json({url:r.url,orderNumber:S})}y||(y=global._mongo={conn:null,promise:null}),n()}catch(e){n(e)}})},706:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>c,default:()=>u,routeModule:()=>p});var a=r(3480),i=r(8667),o=r(6435),s=r(195),d=e([s]);s=(d.then?(await d)():d)[0];let u=(0,o.M)(s,"default"),c=(0,o.M)(s,"config"),p=new a.PagesAPIRouteModule({definition:{kind:i.A.PAGES_API,page:"/api/checkout",pathname:"/api/checkout",bundlePath:"",filename:""},userland:s});n()}catch(e){n(e)}})},2656:(e,t,r)=>{r.d(t,{A:()=>o});var n=r(6037),a=r.n(n);let i=new(a()).Schema({orderNumber:{type:String,required:!0,unique:!0},name:{type:String,required:!0},email:{type:String,required:!0},phone:{type:String},address:{line1:{type:String,required:!0},city:{type:String,required:!0},state:{type:String,required:!0},postal_code:{type:String,required:!0},country:{type:String,required:!0}},items:[{name:{type:String,required:!0},qty:{type:Number,required:!0},price:{type:String,required:!0}}],subtotal:{type:Number,required:!0},tax:{type:Number,required:!0},shipping:{carrier:{type:String,required:!0},rate:{type:Number,required:!0},delivery_days:{type:Number},estimated_delivery:{type:String}},total:{type:Number,required:!0},status:{type:String,default:"Pending"},payment_intent:{type:String,required:!0,unique:!0}},{timestamps:!0,strict:!0});i.pre("save",function(e){console.log("\uD83D\uDCDD Saving Order:",this.toObject()),e()});let o=a().models.Order||a().model("Order",i)},3480:(e,t,r)=>{e.exports=r(5600)},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6037:e=>{e.exports=require("mongoose")},6435:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},8667:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return r}});var r=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9767:e=>{e.exports=import("stripe")}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=706);module.exports=r})();