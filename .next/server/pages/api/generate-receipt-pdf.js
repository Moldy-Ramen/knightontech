"use strict";(()=>{var e={};e.id=608,e.ids=[608],e.modules={1278:e=>{e.exports=require("pdfkit")},3269:(e,t,n)=>{n.d(t,{A:()=>l,T:()=>d});var a=n(6037),o=n.n(a);let r=process.env.MONGODB_URI,i=async()=>{0===o().connection.readyState&&await o().connect(process.env.MONGODB_URI,{useNewUrlParser:!0,useUnifiedTopology:!0})};if(!r)throw Error("Please define the MONGO_URI environment variable inside .env.local");let s=global.mongoose;async function d(){return s.conn||(s.promise||(s.promise=o().connect(r,{bufferCommands:!1}).then(e=>e)),s.conn=await s.promise),s.conn}s||(s=global.mongoose={conn:null,promise:null});let l=i},3480:(e,t,n)=>{e.exports=n(5600)},4916:(e,t,n)=>{n.a(e,async(e,a)=>{try{n.r(t),n.d(t,{default:()=>c});var o=n(3269),r=n(5068),i=n(9767),s=n(1278),d=n.n(s),l=e([i]);let u=new(i=(l.then?(await l)():l)[0]).default(process.env.STRIPE_SECRET_KEY);async function c(e,t){if("POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).end("Method Not Allowed");let{session_id:n}=e.body;if(!n)return t.status(400).json({error:"Missing session_id in request body"});try{await (0,o.T)();let e=await r.A.findOne({sessionId:n});if(e)return t.status(200).json({message:"PDF already exists",receiptId:e._id.toString()});let a=await u.checkout.sessions.retrieve(n,{expand:["line_items.data.price.product","customer_details"]}),i=await u.checkout.sessions.listLineItems(n,{limit:100}),s=new(d())({size:"A4",margin:50}),l=[];s.on("data",e=>l.push(e)),s.on("end",async()=>{let e=Buffer.concat(l),a=new r.A({sessionId:n,pdf:e});return await a.save(),t.status(200).json({message:"PDF generated and stored",receiptId:a._id.toString()})}),s.fontSize(20).text("Order Receipt",{align:"center"}),s.moveDown();let c=a.metadata?.name||a.customer_details?.name||"",p=a.customer_details?.email||"",m=a.customer_details?.phone||a.metadata?.phone||"";s.fontSize(12).text(`Name: ${c}`),s.text(`Email: ${p}`),m&&s.text(`Phone: ${m}`);let f="";if(a.shipping?.address){let e=a.shipping.address;f=`${e.line1}, ${e.city}, ${e.state} ${e.postal_code}, ${e.country}`}else a.metadata.address_line1&&(f=`${a.metadata.address_line1}, ${a.metadata.address_city}, ${a.metadata.address_state} ${a.metadata.address_postal_code}, ${a.metadata.address_country}`);f&&(s.moveDown(),s.text("Shipping Address:"),s.text(f)),s.moveDown();let _=new Date(1e3*a.created).toLocaleString(void 0,{dateStyle:"medium",timeStyle:"short"});s.fontSize(10).fillColor("gray").text(`Order Date: ${_}`),s.fillColor("black"),s.moveDown(),s.fontSize(14).text("Items:",{underline:!0}),s.moveDown(.5),i.data.forEach(e=>{let t=e.description,n=e.quantity,a=(e.amount_total/100).toFixed(2);s.fontSize(12).text(`${t} x ${n}  —  $${a}`)}),s.moveDown();let g=a.total_details?.amount_tax||0,P=a.total_details?.amount_shipping||0,h=a.amount_total||0,x=(g/100).toFixed(2),w=(P/100).toFixed(2),y=(h/100).toFixed(2);s.fontSize(12).text(`Tax: $${x}`),s.text(`Shipping: $${w}`),s.moveDown(),s.fontSize(14).text(`Total: $${y}`,{bold:!0}),s.end()}catch(e){return console.error("❌ Error generating PDF receipt:",e),t.status(500).json({error:"Internal Server Error"})}}a()}catch(e){a(e)}})},5068:(e,t,n)=>{n.d(t,{A:()=>i});var a=n(6037),o=n.n(a);let r=new(o()).Schema({sessionId:{type:String,unique:!0,required:!0},createdAt:{type:Date,default:Date.now},pdf:Buffer}),i=o().models.Receipt||o().model("Receipt",r)},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6037:e=>{e.exports=require("mongoose")},6070:(e,t,n)=>{n.a(e,async(e,a)=>{try{n.r(t),n.d(t,{config:()=>c,default:()=>l,routeModule:()=>u});var o=n(3480),r=n(8667),i=n(6435),s=n(4916),d=e([s]);s=(d.then?(await d)():d)[0];let l=(0,i.M)(s,"default"),c=(0,i.M)(s,"config"),u=new o.PagesAPIRouteModule({definition:{kind:r.A.PAGES_API,page:"/api/generate-receipt-pdf",pathname:"/api/generate-receipt-pdf",bundlePath:"",filename:""},userland:s});a()}catch(e){a(e)}})},6435:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},8667:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return n}});var n=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9767:e=>{e.exports=import("stripe")}};var t=require("../../webpack-api-runtime.js");t.C(e);var n=t(t.s=6070);module.exports=n})();