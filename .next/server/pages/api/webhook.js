"use strict";(()=>{var e={};e.id=954,e.ids=[954],e.modules={1278:e=>{e.exports=require("pdfkit")},1572:e=>{e.exports=require("nodemailer")},2656:(e,t,r)=>{r.d(t,{A:()=>a});var n=r(6037),o=r.n(n);let i=new(o()).Schema({orderNumber:{type:String,required:!0,unique:!0},name:{type:String,required:!0},email:{type:String,required:!0},phone:{type:String},address:{line1:{type:String,required:!0},city:{type:String,required:!0},state:{type:String,required:!0},postal_code:{type:String,required:!0},country:{type:String,required:!0}},items:[{name:{type:String,required:!0},qty:{type:Number,required:!0},price:{type:String,required:!0}}],subtotal:{type:Number,required:!0},tax:{type:Number,required:!0},shipping:{carrier:{type:String,required:!0},rate:{type:Number,required:!0},delivery_days:{type:Number},estimated_delivery:{type:String}},total:{type:Number,required:!0},status:{type:String,default:"Pending"},payment_intent:{type:String,required:!0,unique:!0}},{timestamps:!0,strict:!0});i.pre("save",function(e){console.log("\uD83D\uDCDD Saving Order:",this.toObject()),e()});let a=o().models.Order||o().model("Order",i)},3269:(e,t,r)=>{r.d(t,{A:()=>l,T:()=>d});var n=r(6037),o=r.n(n);let i=process.env.MONGODB_URI,a=async()=>{0===o().connection.readyState&&await o().connect(process.env.MONGODB_URI,{useNewUrlParser:!0,useUnifiedTopology:!0})};if(!i)throw Error("Please define the MONGO_URI environment variable inside .env.local");let s=global.mongoose;async function d(){return s.conn||(s.promise||(s.promise=o().connect(i,{bufferCommands:!1}).then(e=>e)),s.conn=await s.promise),s.conn}s||(s=global.mongoose={conn:null,promise:null});let l=a},3480:(e,t,r)=>{e.exports=r(5600)},3873:e=>{e.exports=require("path")},4016:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>p,default:()=>l,routeModule:()=>c});var o=r(3480),i=r(8667),a=r(6435),s=r(8442),d=e([s]);s=(d.then?(await d)():d)[0];let l=(0,a.M)(s,"default"),p=(0,a.M)(s,"config"),c=new o.PagesAPIRouteModule({definition:{kind:i.A.PAGES_API,page:"/api/webhook",pathname:"/api/webhook",bundlePath:"",filename:""},userland:s});n()}catch(e){n(e)}})},4155:(e,t,r)=>{r.d(t,{X:()=>i});var n=r(1572),o=r.n(n);async function i({to:e,subject:t,text:r,pdfBuffer:n,filename:i}){let a=o().createTransport({host:process.env.SMTP_HOST,port:parseInt(process.env.SMTP_PORT),secure:"true"===process.env.SMTP_SECURE,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}}),s={from:process.env.MAIL_FROM,to:e,subject:t,text:r,attachments:[{filename:i,content:n,contentType:"application/pdf"}]};await a.sendMail(s)}},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5644:e=>{e.exports=require("micro")},6037:e=>{e.exports=require("mongoose")},6435:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},7910:e=>{e.exports=require("stream")},8442:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>b,default:()=>_});var o=r(9767),i=r(5644),a=r(6037),s=r.n(a),d=r(3269),l=r(2656),p=r(1278),c=r.n(p),u=r(7910),m=r(9021),y=r.n(m),g=r(3873),h=r.n(g),f=r(4155),S=e([o]);let w=new(o=(S.then?(await S)():S)[0]).default(process.env.STRIPE_SECRET_KEY),b={api:{bodyParser:!1}},P=e=>new Promise((t,r)=>{let n=[];e.on("data",e=>n.push(e)),e.on("end",()=>t(Buffer.concat(n))),e.on("error",r)});async function v(e){let t=new u.PassThrough,r=new(c())({margin:50});r.pipe(t);let n=h().resolve("./public/img/Knighton_Tech_Black_Only.png");return y().existsSync(n)&&r.image(n,50,40,{width:80}),r.moveDown(),r.fontSize(12).text(`Order #: ${e.orderNumber}`,{align:"right"}).text(`Date: ${new Date(e.createdAt).toLocaleString()}`,{align:"right"}),r.moveTo(50,130).lineTo(550,130).stroke(),r.moveDown(5),r.fontSize(14).text("Customer Information",{underline:!0}),r.fontSize(12).text(`Name: ${e.name}`).text(`Email: ${e.email}`).text(`Phone: ${e.phone||"N/A"}`).text(`Address: ${e.address.line1}, ${e.address.city}, ${e.address.state} ${e.address.postal_code}, ${e.address.country}`).moveDown(),r.fontSize(14).text("Items",{underline:!0}),e.items.forEach(e=>{let t="string"==typeof e.price?parseFloat(e.price.replace("$","")):e.price,n=t*e.qty;r.fontSize(12).text(`${e.name} (x${e.qty}) - $${t.toFixed(2)} each`,{continued:!0}).text(`   Total: $${n.toFixed(2)}`,{align:"right"})}),r.moveDown(),r.fontSize(14).text("Summary",{underline:!0}),r.fontSize(12),r.text(`Subtotal: $${e.subtotal.toFixed(2)}`),r.text(`Tax: $${e.tax.toFixed(2)}`),e.shipping&&"object"==typeof e.shipping&&r.text(`Shipping (${e.shipping.carrier}): $${e.shipping.rate.toFixed(2)}`),r.moveDown(),r.fontSize(13).text(`Total: $${e.total.toFixed(2)}`,{bold:!0}),r.moveDown(2).fontSize(10).fillColor("gray").text("Thank you for shopping with Knighton Tech!",{align:"center"}),r.end(),await P(t)}async function _(e,t){let r;if(console.log("\uD83D\uDECE️ webhook handler invoked",{method:e.method}),"POST"!==e.method)return t.setHeader("Allow","POST"),t.status(405).end("Method Not Allowed");console.log("\uD83D\uDCEC Stripe webhook received");try{console.log("\uD83D\uDD11 verifying signature…");let t=e.headers["stripe-signature"],n=await (0,i.buffer)(e);r=w.webhooks.constructEvent(n,t,process.env.STRIPE_WEBHOOK_SECRET),console.log("✅ signature OK, got event:",r.type)}catch(e){return console.error("❌ signature failed:",e.message),t.status(400).send(`Webhook Error: ${e.message}`)}if(console.log("\uD83D\uDD0C connecting to Mongo…"),await (0,d.A)(),console.log("\uD83D\uDDC4️  Mongo connected, state=",s().connection.readyState),"payment_intent.succeeded"===r.type){let e=r.data.object;console.log("\uD83D\uDCB3 PaymentIntent ID:",e.id);let n=e.metadata||{};console.log("\uD83D\uDCE6 Metadata:",n),console.log("\uD83D\uDCE5 about to write order for PaymentIntent:",e.id);let o=parseFloat(n.subtotal_amount||"0")||0,i=parseFloat(n.tax_amount||"0")||0,a=parseFloat(n.shipping_rate||"0")||0,s=n.shipping_carrier||"",d=n.shipping_delivery_days?parseInt(n.shipping_delivery_days,10):void 0,p=n.shipping_estimated_delivery||"",c=n.delivery_option||"Unknown",u=[];try{let e=JSON.parse(n.items||"[]");Array.isArray(e)&&(u=e)}catch(e){console.warn("⚠️ Could not parse metadata.items:",n.items,e)}u.length||(console.warn("⚠️ No items parsed from metadata. Using fallback item."),u=[{name:"Unknown",qty:1,price:"$0.00"}]);let m={line1:n.address_line1||"",city:n.address_city||"",state:n.address_state||"",postal_code:n.address_postal_code||"",country:n.address_country||""},y=n.email||e.receipt_email||"";if(!y)return console.error("❌ No email found in metadata or intent. Aborting."),t.status(400).json({error:"Email is required"});try{if(await l.A.findOne({payment_intent:e.id}))return console.log("▶️ Order already exists for paymentIntent:",e.id),t.status(200).json({received:!0});let r={orderNumber:`KT-${Date.now()}`,name:n.name||"",email:y,phone:n.phone||"",address:m,items:u.map(e=>({name:e.name,qty:e.qty,price:e.price})),subtotal:o,tax:i,shipping:{carrier:s,rate:a,delivery_days:d,estimated_delivery:p||void 0},total:o+i+a,status:"Paid",payment_intent:e.id,deliveryOption:c};console.log("\uD83D\uDCE6 Order Payload:",r);let g=await new l.A(r).save();console.log("✅ Order saved to DB via webhook:",g._id);let h=await v(g);await (0,f.X)({to:g.email,subject:`Your Receipt for Order ${g.orderNumber}`,text:"Attached is your receipt. Thank you for shopping with us!",pdfBuffer:h,filename:`receipt-${g.orderNumber}.pdf`})}catch(e){return console.error("❌ failed in webhook logic:",e),"ValidationError"===e.name&&Object.keys(e.errors).forEach(t=>{console.error(`Field ${t}:`,e.errors[t].message)}),t.status(500).json({error:"Webhook handler error"})}}t.status(200).json({received:!0})}n()}catch(e){n(e)}})},8667:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return r}});var r=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9021:e=>{e.exports=require("fs")},9767:e=>{e.exports=import("stripe")}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=4016);module.exports=r})();