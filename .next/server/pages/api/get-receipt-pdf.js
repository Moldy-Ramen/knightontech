"use strict";(()=>{var e={};e.id=571,e.ids=[571],e.modules={1278:e=>{e.exports=require("pdfkit")},2656:(e,t,r)=>{r.d(t,{A:()=>a});var n=r(6037),i=r.n(n);let o=new(i()).Schema({orderNumber:{type:String,required:!0,unique:!0},name:{type:String,required:!0},email:{type:String,required:!0},phone:{type:String},address:{line1:{type:String,required:!0},city:{type:String,required:!0},state:{type:String,required:!0},postal_code:{type:String,required:!0},country:{type:String,required:!0}},items:[{name:{type:String,required:!0},qty:{type:Number,required:!0},price:{type:String,required:!0}}],subtotal:{type:Number,required:!0},tax:{type:Number,required:!0},shipping:{carrier:{type:String,required:!0},rate:{type:Number,required:!0},delivery_days:{type:Number},estimated_delivery:{type:String}},total:{type:Number,required:!0},status:{type:String,default:"Pending"},payment_intent:{type:String,required:!0,unique:!0}},{timestamps:!0,strict:!0});o.pre("save",function(e){console.log("\uD83D\uDCDD Saving Order:",this.toObject()),e()});let a=i().models.Order||i().model("Order",o)},3315:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{default:()=>y});var i=r(6037),o=r.n(i),a=r(2656),d=r(1278),s=r.n(d),p=r(9021),u=r.n(p),l=r(3873),c=r.n(l),m=r(4685),g=e([m]);m=(g.then?(await g)():g)[0];let x=process.env.MONGODB_URI;if(!x)throw Error("Define MONGODB_URI in .env.local");let S=global._mongo;async function f(){return S.conn||(S.promise||(S.promise=o().connect(x,{useNewUrlParser:!0,useUnifiedTopology:!0}).then(e=>e)),S.conn=await S.promise),S.conn}async function y(e,t){let{query:{orderNumber:r,session_id:n,payment_intent:i}}=e;await f();let o=null;if(r?o=await a.A.findOne({orderNumber:r}):i?o=await a.A.findOne({sessionId:i}):n&&(o=await a.A.findOne({sessionId:n})),!o)return t.status(404).json({error:"Order not found"});let d=new(s())({margin:50});t.setHeader("Content-Type","application/pdf"),t.setHeader("Content-Disposition",`attachment; filename="receipt-${o.orderNumber||"order"}.pdf"`),d.pipe(t);let p=c().resolve("./public/img/Knighton_Tech_Black_Only.png");u().existsSync(p)&&d.image(p,50,40,{width:80}),d.moveDown(),d.fontSize(12).text(`Order #: ${o.orderNumber}`,{align:"right"}).text(`Date: ${new Date(o.createdAt).toLocaleString()}`,{align:"right"}),d.moveTo(50,130).lineTo(550,130).stroke(),d.moveDown(),d.moveDown(5),d.fontSize(14).text("Customer Information",{underline:!0}),d.fontSize(12).text(`Name: ${o.name}`).text(`Email: ${o.email}`).text(`Phone: ${o.phone||"N/A"}`).text(`Address: ${o.address.line1}, ${o.address.city}, ${o.address.state} ${o.address.postal_code}, ${o.address.country}`).moveDown(),d.fontSize(14).text("Items",{underline:!0}),o.items.forEach(e=>{let t="string"==typeof e.price?parseFloat(e.price.replace("$","")):e.price,r=t*e.qty;d.fontSize(12).text(`${e.name} (x${e.qty}) - $${t.toFixed(2)} each`,{continued:!0}).text(`   Total: $${r.toFixed(2)}`,{align:"right"})}),d.moveDown(),d.fontSize(14).text("Summary",{underline:!0}),d.fontSize(12),d.text(`Subtotal: $${o.subtotal.toFixed(2)}`),d.text(`Tax: $${o.tax.toFixed(2)}`),d.text(`Shipping (${o.shipping.carrier}): $${o.shipping.rate.toFixed(2)}`),d.moveDown(),d.fontSize(13).text(`Total: $${o.total.toFixed(2)}`,{bold:!0}),d.moveDown(2).fontSize(10).fillColor("gray").text("Thank you for shopping with Knighton Tech!",{align:"center"}),d.end()}S||(S=global._mongo={conn:null,promise:null}),n()}catch(e){n(e)}})},3480:(e,t,r)=>{e.exports=r(5600)},3873:e=>{e.exports=require("path")},4685:e=>{e.exports=import("get-stream")},5600:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6037:e=>{e.exports=require("mongoose")},6435:(e,t)=>{Object.defineProperty(t,"M",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},8278:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>u,default:()=>p,routeModule:()=>l});var i=r(3480),o=r(8667),a=r(6435),d=r(3315),s=e([d]);d=(s.then?(await s)():s)[0];let p=(0,a.M)(d,"default"),u=(0,a.M)(d,"config"),l=new i.PagesAPIRouteModule({definition:{kind:o.A.PAGES_API,page:"/api/get-receipt-pdf",pathname:"/api/get-receipt-pdf",bundlePath:"",filename:""},userland:d});n()}catch(e){n(e)}})},8667:(e,t)=>{Object.defineProperty(t,"A",{enumerable:!0,get:function(){return r}});var r=function(e){return e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE",e.IMAGE="IMAGE",e}({})},9021:e=>{e.exports=require("fs")}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=8278);module.exports=r})();